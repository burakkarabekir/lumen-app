name: Mobile CI (CMP)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:

  # =========================
  # Detect changed files
  # =========================
  changes:
    runs-on: ubuntu-latest
    outputs:
      android: ${{ steps.filter.outputs.android }}
      ios: ${{ steps.filter.outputs.ios }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            android:
              - 'androidApp/**'
              - 'composeApp/**'
              - 'core/**'
              - 'feature/**'
              - 'build-logic/**'
              - '*.gradle*'
              - 'gradle/**'
            ios:
              - 'iosApp/**'
              - 'composeApp/**'
              - 'core/**'
              - 'feature/**'
              - 'build-logic/**'
              - '*.gradle*'
              - 'gradle/**'

  # =========================
  # ANDROID
  # =========================
  android:
    name: Android Build
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.android == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Restore Firebase config
      - name: Restore google-services.json
        run: |
          echo '${{ secrets.ANDROID_GOOGLE_SERVICES_JSON }}' > androidApp/google-services.json

      # Cache Gradle
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build Android
        run: ./gradlew assembleDebug

      - name: Test Android
        run: ./gradlew test


  # =========================
  # iOS
  # =========================
  ios:
    name: iOS Build & Test
    runs-on: macos-latest
    needs: changes
    if: needs.changes.outputs.ios == 'true'

    defaults:
      run:
        working-directory: iosApp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Restore Firebase plist
      - name: Restore GoogleService-Info.plist
        run: |
          echo '${{ secrets.IOS_GOOGLE_SERVICES_JSON }}' > GoogleService-Info.plist

      # Cache Gradle (shared module)
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-macos-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-macos

      # Cache Xcode DerivedData
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: deriveddata-${{ runner.os }}-${{ hashFiles('iosApp/**/*.xcodeproj/**', 'iosApp/**/*.xcworkspace/**') }}
          restore-keys: |
            deriveddata-${{ runner.os }}

      - name: Detect scheme
        run: |
          SCHEME=$(xcodebuild -list -json | ruby -e "require 'json'; puts JSON.parse(STDIN.read)['project']['schemes'][0]")
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV
          echo "Using scheme: $SCHEME"

      - name: Detect project/workspace
        run: |
          if ls *.xcworkspace 1> /dev/null 2>&1; then
            echo "TYPE=workspace" >> $GITHUB_ENV
            echo "FILE=$(ls *.xcworkspace | head -n 1)" >> $GITHUB_ENV
          else
            echo "TYPE=project" >> $GITHUB_ENV
            echo "FILE=$(ls *.xcodeproj | head -n 1)" >> $GITHUB_ENV
          fi

      - name: Build iOS
        run: |
          xcodebuild build-for-testing \
            -scheme "$SCHEME" \
            -$TYPE "$FILE" \
            -destination "platform=iOS Simulator,name=iPhone 15"

      - name: Test iOS
        run: |
          xcodebuild test-without-building \
            -scheme "$SCHEME" \
            -$TYPE "$FILE" \
            -destination "platform=iOS Simulator,name=iPhone 15"